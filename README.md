# Cloudwatcher AWS CloudFormation Templates

Open-source CloudFormation templates for monitoring AWS Organizations with CloudWatch alarms and automated email notifications.

## 🎯 What is Cloudwatcher?

Cloudwatcher is an AWS security monitoring solution that automatically detects and alerts on suspicious activities in your AWS Organization. It monitors CloudTrail logs for security-relevant events and sends formatted email notifications when alarms are triggered.

### Key Features

- **🔐 Security Monitoring** - Tracks IAM, STS, and SSO events across your AWS Organization
- **📧 Email Notifications** - Sends formatted alerts via SNS when suspicious activity is detected
- **🏢 Multi-Account Support** - Works across all accounts in your AWS Organization
- **⚡ Serverless** - Built entirely on AWS Lambda and CloudWatch
- **🔄 Automated Deployment** - CI/CD pipeline for easy updates

## 📋 What Gets Deployed

### Root Stack (`RootStack.yaml`)
Main orchestration template that deploys:

1. **CloudWatch Alarms Stack** - Metric filters and alarms for security events
2. **Forwarding Lambda Stack** - Processes alarms and sends email notifications

### Monitored Events

- **Access Denied** - Failed authorization attempts
- **GetCallerIdentity** - Identity verification calls
- **AttachUserPolicy** - Policy attachment to users
- **Authenticate** - SSO authentication events
- **CreateUser** - New IAM user creation
- **DeleteUser** - IAM user deletion

## 🚀 Deployment

### Prerequisites

- AWS Organization with CloudTrail enabled
- CloudTrail logs sent to CloudWatch Log Group
- Email addresses for receiving alerts

### Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `LogGroupName` | CloudWatch Log Group name | `aws-controltower/CloudTrailLogs` |
| `Environment` | Deployment environment | `prod` |
| `EmailRecipients` | Comma-separated email addresses | Required |

### Deploy via AWS Console

#### Stage Environment
```
https://cloudwatcher-cloudformation-stage.s3.eu-central-1.amazonaws.com/templates/organisation/0.1/RootStack.yaml
```

#### Production Environment
```
https://cloudwatcher-cloudformation-prod.s3.eu-central-1.amazonaws.com/templates/organisation/0.1/RootStack.yaml
```

### Deploy via AWS CLI

```bash
aws cloudformation create-stack \
  --stack-name cloudwatcher-monitoring \
  --template-url https://cloudwatcher-cloudformation-stage.s3.eu-central-1.amazonaws.com/templates/organisation/0.1/RootStack.yaml \
  --parameters \
    ParameterKey=LogGroupName,ParameterValue=aws-controltower/CloudTrailLogs \
    ParameterKey=Environment,ParameterValue=stage \
    ParameterKey=EmailRecipients,ParameterValue=security@example.com,admin@example.com \
  --capabilities CAPABILITY_IAM
```

## 📧 Email Notifications

When an alarm triggers, you'll receive an email with:

```
═══════════════════════════════════════════════════════════
🚨 CloudWatch Alarm: iam:AccessDeniedAlarm
═══════════════════════════════════════════════════════════

Status:     OK → ALARM
Timestamp:  2025-10-29 22:15:30 UTC
Account:    Production Account (123456789012)

────────────────────────────────────────────────────────────
📋 CloudWatch Log Entries (3 found)
────────────────────────────────────────────────────────────

[1] 2025-10-29 22:15:28 UTC
    Event:      DeleteUser
    User:       AIDAI3EXAMPLE
    Source IP:  203.0.113.42
    Error:      AccessDenied

[2] 2025-10-29 22:15:29 UTC
    Event:      AttachUserPolicy
    User:       AIDAI3EXAMPLE
    Source IP:  203.0.113.42
    Error:      AccessDenied

────────────────────────────────────────────────────────────
Generated by Cloudwatcher
═══════════════════════════════════════════════════════════
```

## 🏗️ Architecture

```
CloudTrail Logs
    ↓
CloudWatch Log Group
    ↓
Metric Filters
    ↓
CloudWatch Alarms
    ↓
Lambda Function (Forwarding)
    ↓
SNS Topic
    ↓
Email Recipients
```

## 🤝 Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Test your changes with `./tests/validate-templates.sh`
4. Submit a pull request

## 📝 License

This project is open source and available under the MIT License.

### Email Confirmation

After deployment, each email recipient will receive a confirmation email from AWS SNS. **You must confirm the subscription** to receive alerts.

### Costs

This solution uses:
- AWS Lambda (minimal cost, mostly free tier eligible)
- CloudWatch Logs (depends on log volume)
- CloudWatch Alarms (first 10 alarms free, then $0.10/alarm/month)
- SNS (first 1,000 emails free, then $2/100,000 emails)

### Security

- Templates are publicly readable in S3 (required for CloudFormation)
- No sensitive data is stored in templates
- Lambda execution role has minimal required permissions
- All resources are encrypted at rest

## 📞 Support

For questions or issues:
- Open a GitHub Issue
- Check existing documentation in `/tests/README.md`
- Review CloudFormation events for deployment errors

---

**Made with ❤️ for AWS security monitoring**
